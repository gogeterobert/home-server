- name: Deploy Prometheus Operator
  hosts: servers
  become: yes
  tasks:
    - name: Check if monitoring namespace exists
      command: kubectl get namespace monitoring
      register: namespace_check
      ignore_errors: yes

    - name: Create monitoring namespace if not exists
      command: kubectl create namespace monitoring
      when: namespace_check.rc != 0

    - name: Check if Prometheus CRD exists
      command: kubectl get crd prometheuses.monitoring.coreos.com
      register: prometheus_crd_check
      failed_when: false
      changed_when: false

    - name: Install Prometheus CRDs
      command: kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
      when: prometheus_crd_check.rc != 0
      register: crd_apply
      failed_when: crd_apply.rc != 0
